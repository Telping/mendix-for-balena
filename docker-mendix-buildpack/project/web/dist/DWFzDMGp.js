import{n as R,aK as x,ad as b,cz as p,k as y,dg as g,O as C,b1 as S,aC as v,dh as F,w as W,j as O,di as A,dj as P,dk as M,cG as q,dl as N,aQ as k,dm as E,bU as J,H as _,aA as I,aP as D,dn as K,dd as Q,r as j,aj as H,dp as Z,ak as B,dq as X,V,al as Y,dr as ee}from"./DTxgj959.js";async function G(){const n=p(),i=n.showProgress(void 0,!0);try{await O().synchronizeOffline()}finally{n.hideProgress(i)}}async function L(n){return await g(n,"publish","submit"),await g(n,"publish","commit"),n.getSubmitObjects()}async function T(n,i,c){const[m,d]=function(s){const e={},t={};return Object.keys(s).forEach(o=>{o.startsWith(U)?e["$"+o.substring(U.length)]=s[o]:t[o]=s[o]}),[e,t]}(c);let r=[{}];for(const[s,e]of Object.entries(m))if(e){if("object"in e)r.forEach(t=>t[s]=e.object);else if("objects"in e){if(r.length!==1)throw new b("Multiple parameters with multiple objects are not supported");const t=r[0];r=e.objects.map(o=>({...t,[s]:o}))}else if("id"in e){const t=await _(e.id);r.forEach(o=>o[s]=t)}else if("ids"in e)throw new b("Parameters with multi-selection are not supported")}else r.forEach(t=>t[s]=void 0);i.abortOnClientValidations&&await i.currentForm.triggerValidation(),i.abortOnServerValidations&&await g(O(),"validate",i.currentForm.getSubmitObjects());const f=await Promise.all(r.map(async function(s){let e;if(n.specializations){const u=s[n.specializations.argument];e=u?n.specializations.pageSettings[u.getEntity()]:void 0}const t=e??n,o=t.title?await P(t.title,d)??"":void 0,a=n.numberOfPagesToClose?A(await P(n.numberOfPagesToClose,d)):void 0,l=t.params?I(t.params,u=>s[u]?.getGuid()):I(s,u=>u?.getGuid());return p().openForm2(t.name,l,o,i.currentForm,{...t,formParams:i.formParams},a)}));return r.length>1?f:f[0]}const U="param$",z=R.get().getLogger();async function te(n,i){const c="addressAttribute"in n?await g(C(i),"fetch",n.addressAttribute):n.address,m=function(d,r){if(r==null)return void z.error("Attempted to open missing link URL");switch(d){case"email":return`mailto:${escape(r)}`;case"call":return`tel:${escape(r)}`;case"text":return`sms:${escape(r)}`;default:const f=r.trim().toLowerCase();return f.startsWith("javascript:")||f.startsWith("vbscript:")||f.startsWith("data:")?void z.error("Attempted to open invalid link URL",r):r}}(n.schema,c);m!==void 0&&(n.schema==="web"?window.open(m,"_blank","noopener"):window.open(m,"_self"))}function ne(n,i,c,m,d){const r=x();function f(e){return"$object"in e&&e.$object?"object"in e.$object?e.$object.object:S():void 0}function s(e){d?d(e):e instanceof k||D(e)}r.hasSomeRole(n.config.allowedRoles)?async function(){switch(n.type){case"callMicroflow":return async function(e,t,o){const a=p(),l=e.confirmation;if(l&&!await new Promise(w=>a.confirmation({cancel:l.cancel,proceed:l.proceed,content:l.question,handler:()=>w(!0),onCancel:()=>w(!1)})))return;if(t.beforeExecuteAction&&t.beforeExecuteAction(),t.abortOnClientValidations)switch(e.validate){case"node":if(!t.widgetIsValid)throw new k;break;case"view":await t.currentForm.triggerValidation()}const u=e.progress?a.showProgress(e.progress.message,e.progress.modal):void 0;try{await g(t.currentForm,"publish","submit");const w=t.abortOnServerValidations?t.currentForm.getSubmitObjects().map(h=>h.getGuid()):[];mx.isOffline()?await v().executeMicroflow(e.operationId,E(o),t.currentForm,w,!!e.async):await y().executeMicroflow(e.operationId,E(o),t.currentForm,w,!!e.async)}finally{u!==void 0&&a.hideProgress(u)}}(n.config,i,c);case"callNanoflow":return async function(e,t,o){t.beforeExecuteAction&&t.beforeExecuteAction(),t.abortOnClientValidations&&await t.currentForm.triggerValidation(),await g(t.currentForm,"publish","submit"),await q.execute(e.nanoflow,await N(o),t.currentForm)}(n.config,i,c);case"cancelChanges":return M(n.config,i);case"closePage":return async function(e,{currentForm:t},o){const a=e.numberOfPagesToClose?A(await P(e.numberOfPagesToClose,o)):1;if(a<1)throw new b(`The number of pages to close evaluated to ${a}. It must be at least 1.`);return t.closePage(a)}(n.config,i,c);case"doNothing":return;case"openLink":return te(n.config,f(c));case"openPage":return T(n.config,i,c).then(()=>{});case"saveChanges":return async function(e,{currentForm:t}){await t.triggerValidation(),t.setSuspend(!0);try{const o=await L(t);mx.isOffline()?await new Promise((a,l)=>{O().commit({mxobjs:o,callback:a,error:l})}):await y().executeObjectAction(e.operationId,"commit",o);try{e.syncAutomatically&&await G()}finally{e.closePage&&await g(t,"close")}}finally{t.setSuspend(!1)}}(n.config,i);case"signOut":return async function(){x().isGuest()||(p().showProgress(void 0,!0),mx.logout())}();case"synchronize":return G();case"deleteObject":return async function(e,{currentForm:t},o){let a;if(o)if("object"in o)a=[o.object];else if("objects"in o)a=o.objects;else if("id"in o)a=await F([o.id]);else{if(!("ids"in o))throw new b;a=await F(o.ids)}else a=[];const l=W(a.length>1?"mxui.widget.DataGrid":"mxui.sys.UI","confirm_delete",a.length.toString()),u=p();if(await new Promise(w=>u.confirmation({content:l,handler:()=>{w(!0)},onCancel:()=>{w(!1)}}))){t.setSuspend(!0);try{mx.isOffline()?await v().delete(a):e.operationId&&await y().executeObjectAction(e.operationId,"delete",a),e.closePage&&await g(t,"close")}finally{t.setSuspend(!1)}}}(n.config,i,c.$object);case"createObject":return async function(e,t,{$object:o,...a}){const l=o?"object"in o?o.object:S():void 0;if("association"in e&&l===void 0)throw new b;const u=p(),w=u.showProgress("",!1);try{let h;h=mx.isOffline(e.entity)?await v().create(e.entity):await y().createObject(e.entity,e.operationId),e.association&&h.addReference(e.association,l.getGuid()),await T({...e.pageSettings,numberOfPagesToClose:e.numberOfPagesToClose},t,{[e.objectParameter]:{object:h},...a})}finally{u.hideProgress(w)}}(n.config,i,c);case"callExternalAction":return async function(e,{currentForm:t},o){e.commit&&await t.triggerValidation(),e.closePage&&t.setSuspend(!0);try{const a=e.confirmation;if(a&&!await new Promise(u=>p().confirmation({cancel:a.cancel,proceed:a.proceed,content:a.question,handler:()=>u(!0),onCancel:()=>u(!1)})))return;const l=e.commit?await L(t):[];await y().executeExternalAction(e.operationId,o,l),e.closePage&&await g(t,"close")}finally{t.setSuspend(!1)}}(n.config,i,C(f(c)));default:throw new b}}().then(m,s):r.isGuest()?p().showLogin():s(new J("Unable to execute action because you do not have sufficient permissions."))}const oe=n=>K(Q(n.value));function ae(n,i){if(typeof n!="string"||n.length===0)throw new b("Key must be defined");const c=j.useContext(H);j.useDebugValue(`usePersistentState(${n}, ${c})`),Z(n,c);const m=`hook:${n}`,[d,r]=B(c,m);X(c,m);const f=j.useCallback(s=>{s instanceof Function?f(s(V(d))):s!==void 0?($(s),r(JSON.parse(JSON.stringify(s)))):r(void 0)},[d]);return j.useMemo(()=>{V(d)===void 0&&f(typeof i=="function"?i():i)},[]),[Y(d),f]}function $(n){if(!["boolean","number","string"].includes(typeof n)&&n!==null)if(Array.isArray(n))n.forEach($);else{if(!ee(n))throw new b(`usePersistentState: received non-primitive value ${n}`);Object.values(n).forEach($)}}export{ae as C,oe as m,ne as q};
