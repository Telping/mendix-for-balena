import{as as K,at as te,T as A,au as ae,V as E,P as h,av as se,aw as re,n as U,m as W,ax as _,ay as oe,q as ne,az as ie,h as ue,aA as le,a5 as k,$ as L,aB as de,a2 as z,O as Z,M as G,aC as fe,aD as ce,a6 as me,R as ve,k as ge,aE as D,aF as be,aG as Oe}from"./DTxgj959.js";import{b as he,l as $e,u as pe,d as Ie,V as je,T as H,I as J,g as Ce,N as Me}from"./D-Sagn14.js";function Y(t,c,n,m,p,b){const{fetchTrigger$:l,retrieveParameters$:o,silentlyResetOffset:e,needTotalCount$:s,immediateRetrieveParametersSetters:d,delayedRetrieveParametersSetters:v,loadedCallback:u}=he(t,c,n,m,p),V=K(`Load data of ${m}`,()=>{const a=l.dependOn();if(a.status!=="available")return a;const r=o.dependOn();if(a.value.empty)return h({offset:r.offset,limit:0,sortOrder:r.sortOrder,filter:r.filter,objects:[],hasMoreItems:!0,parameters:void 0,triggerId:-1,requestedTotalCount:!1});const{parameters:j,id:C}=a.value,g=s.dependOn(),i=E(T),{sliceToKeep:$,pageToFetch:y,loadAtEnd:S}=function(f,O){if(f.status!=="available")return{};if(!je(f.value.sortOrder,O.sortOrder))return{};if(!se(f.value.filter,O.filter))return{};const[M,F]=[f.value.offset,f.value.offset+f.value.limit],[R,q]=[O.offset,O.offset+O.limit],[N,x]=[Math.max(M,R),Math.min(F,q)];if(N>=x)return{};if(R<N&&q>x)return{};const X=q>F,B={offset:X?x:R,limit:q-R-(x-N)};return{sliceToKeep:[N-M,x-M],loadAtEnd:X,pageToFetch:B.limit>0?B:void 0}}(i,r);if(i.status!=="available"||i.value.triggerId!==C||g&&!i.value.requestedTotalCount||$===void 0)return b(j,r,g).then(({mxObjects:f,totalCount:O,hasMoreItems:M})=>h({...r,parameters:j,triggerId:C,objects:f,totalCount:O,hasMoreItems:M,requestedTotalCount:g}));if(y===void 0)return h({...i.value,...r,objects:i.value.objects.slice(...$),hasMoreItems:!!($[1]&&$[1]<i.value.objects.length)||i.value.hasMoreItems,totalCount:g?i.value.totalCount:void 0,requestedTotalCount:g});{const f=i.value.objects.slice(...$);return[i,b(j,{...y,sortOrder:r.sortOrder,filter:r.filter},g).then(({mxObjects:O,hasMoreItems:M,totalCount:F})=>h({...i.value,...r,objects:S?f.concat(O):O.concat(f),hasMoreItems:S?M:i.value.hasMoreItems,totalCount:F,requestedTotalCount:g}))]}}),T=K(`Retry to load data of ${m}`,()=>{const a=V.dependOn();if(a.status!=="available"||a.value.objects.length>0||a.value.offset===0)return a;if(re(e),a.value.limit===0)return h({...a.value,offset:0});const{limit:r,sortOrder:j,filter:C}=E(o),g=E(s);return b(a.value.parameters,{limit:r,offset:0,sortOrder:j,filter:C},g).then(({mxObjects:i,totalCount:$,hasMoreItems:y})=>h({...a.value,limit:r,sortOrder:j,filter:C,offset:0,objects:i,totalCount:$,hasMoreItems:y}))}),w=te(m,n,T,a=>a.objects),P=A(`Prepare data of ${m}`,()=>{const a=w.dependOn();let r;if(a.status==="available"){const{objects:j,totalCount:C,offset:g,limit:i,hasMoreItems:$,sortOrder:y,filter:S}=a.value;r={status:"available",offset:g,limit:i,sortOrder:y,filter:S,items:j.map(f=>ae(f,t.dataSourceId)),hasMoreItems:$,totalCount:C,...v}}else r={status:a.status,...E(o),...d};return r.status!=="loading"&&n.addUpdateCallback(u),r}),I=$e(m,t.dataSourceId,P,n);return pe(Ie(I,n,m))}const Q=U.get().getLogger(),ye=W((t,c,n,m)=>{const p=Object.fromEntries(Object.entries(t.arguments??{}).map(([o,[e,s,d]])=>_(o,d?oe(o,{widget:e,source:"localvariable"},c):s===void 0?ne(c,e):ie(c,e,s)))),b=t.constraints,l=b?A(`queryFilter for ${n}/${m}`,()=>{const o=le(p,e=>e.dependOn());return Object.values(o).some(e=>e.status==="loading")?k():Object.values(o).some(e=>e.status==="unavailable")&&t.fetchOnlyWithAllParams?L():h(de(b,(e,s)=>z(Z(o[s?`${e}$${s}`:e]),void 0)))}):ue(h(void 0));return Y(t,t.sort?H(t.sort,t.dataSourceId):[],c,n,l,async function(o,{offset:e,limit:s,sortOrder:d,filter:v},u){const V={offset:e,...s!==Number.POSITIVE_INFINITY?{amount:s}:{},sort:J(d)},T=function(I,a){if(a===void 0)return I;const r=Ce(a);return I===void 0?r:{type:"function",name:"and",parameters:[I,r]}}(o,v);Q.debug(`Fetching data for entity '${t.entity}' for widget ${G(n)}`);const{mxObjects:w,count:P}=await fe().retrieve(t.entity,T,V);return function(I){Q.debug(`Received ${I.length} objects for widget ${G(n)}`,"object ids:",I.map(a=>a.getGuid()))}(w),{mxObjects:w,totalCount:u?P:void 0,hasMoreItems:e+s<P}})}),ee=U.get().getLogger(),xe=W((t,c,n,m)=>Y(t,t.sort?H(t.sort,t.dataSourceId):[],c,n,function(p=!1){const b=Object.entries(t.arguments??{}).map(([l,[o,e,s]])=>{const d=`Subexpression ${l} in ${n}/${m}`;if(s)return{name:l,value$:ce(l,o,d,c)};{const[v]=c.useSlot(o,"object");return{name:l,value$:A(d,()=>me(ve(v.dependOn()??k(),u=>u.isUnavailable()?L():h(u)),u=>(D({guid:u.getGuid(),tag:n},c),e===void 0?be(u):(D({guid:u.getGuid(),attr:e,tag:n},c),Oe(u,e)))))}}});return A(`Runtime arguments of ${n}/${m}`,()=>{const l=b.map(({name:e,value$:s})=>({name:e,value:s.dependOn()}));if(l.some(({value:e})=>e.status==="loading"))return k();if(l.some(({value:e})=>e.status==="unavailable")&&p)return L();const o=l.map(({name:e,value:s})=>({name:e,value:z(s,void 0)})).filter(({value:e})=>e!==void 0).map(({name:e,value:s})=>_(e,Z(s)));return h(Object.fromEntries(o))})}(t.fetchOnlyWithAllParams),async function(p,{offset:b,limit:l,sortOrder:o,filter:e},s){(function(v){const u=G(n);ee.debug(Object.values(v).length?`Fetching data using XPath with arguments '${JSON.stringify(v)}' and operationId '${t.operationId}' for widget ${u}`:`Fetching data using XPath with operationId '${t.operationId}' for widget ${u}`)})(p);const d=await ge().retrieveByXPath(t.operationId,p,Me(e),{offset:b,amount:l,sort:J(o)},s);return function(v){ee.debug(`Received ${v.length} objects for widget ${G(n)}`,"object ids:",v.map(u=>u.getGuid()))}(d.mxObjects),{mxObjects:d.mxObjects,hasMoreItems:d.hasMoreItems,totalCount:d.count}})),Te=t=>mx.isOffline(t.entity)?ye(t):xe(t);export{Te as o};
